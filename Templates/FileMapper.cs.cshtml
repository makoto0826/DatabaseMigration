// Generated @Model.Now.ToString()
@using System

@functions {
    public string AppendConvertMethodIf(string value,string? convertMethod)
    {
        if(String.IsNullOrEmpty(convertMethod))
        {
            return value;
        }
        else
        {
            return $"{value}.{convertMethod}()";
        }
    }
}

namespace @Model.Migration.ProjectName
{
    public class @(Model.Migration.SourceName)FileMapper
    {
        private readonly string _filePath;

        public @(Model.Migration.SourceName)FileMapper(string filePath)
        {
            _filePath = filePath;
        }

        public void Map(System.Data.DataTable dataTable)
        {
            using var reader = new System.IO.StreamReader(_filePath,System.Text.Encoding.GetEncoding("Shift-JIS"));
            string? line = null;
            var lineCount = 1;

            while((line = reader.ReadLine()) != null)
            {
                var row = dataTable.NewRow();

                @foreach(var column in Model.Migration.Table.Columns)
                {
                    var name = column.Destination.Name.ToLower();
                    @:try
                    @:{
                        @if(column.IsGeneration)
                        {
                        @:row["@column.Destination.Name"] = @column.GenerationMethod;
                        }
                        else
                        {
                        @:var @name = line[@column.Source.StartPosition..@(column.Source.EndPosition + 1)];
                        @:row["@column.Destination.Name"] = @AppendConvertMethodIf(name,column.ConvertMethod);
                        }
                    @:}
                    @:catch(System.Exception ex)
                    @:{
                        if(column.Source == null)
                        {
                        @:System.Console.WriteLine($"{lineCount}行目 列名:@(column.Destination.Name)");
                        }
                        else
                        {
                        @:System.Console.WriteLine($"{lineCount}行目 開始位置:@(column.Source.StartPosition) 終了位置:@(column.Source.EndPosition) 列名:@(column.Destination.Name)");
                        }
                        @:System.Console.WriteLine(ex.Message);

                        @:throw;
                    @:}
                }

                lineCount++;
                dataTable.Rows.Add(row);
            }
        }
    }
}